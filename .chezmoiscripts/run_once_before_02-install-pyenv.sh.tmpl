{{- if eq .chezmoi.os "linux" -}}
#!/bin/bash
set -euo pipefail

# Check for required build dependencies
check_build_deps() {
    local missing=()
    for cmd in make gcc; do
        if ! command -v "$cmd" &>/dev/null; then
            missing+=("$cmd")
        fi
    done
    for lib in libssl-dev zlib1g-dev libbz2-dev libreadline-dev libsqlite3-dev libffi-dev; do
        if ! dpkg -s "$lib" &>/dev/null 2>&1; then
            missing+=("$lib")
        fi
    done
    if [ ${#missing[@]} -gt 0 ]; then
        echo "WARNING: Missing Python build dependencies: ${missing[*]}"
        echo "Install with: sudo apt-get install build-essential libssl-dev zlib1g-dev libbz2-dev libreadline-dev libsqlite3-dev libncursesw5-dev xz-utils tk-dev libxml2-dev libxmlsec1-dev libffi-dev liblzma-dev"
        return 1
    fi
    return 0
}

if [ ! -d "$HOME/.pyenv" ]; then
    echo "Installing pyenv..."
    git clone https://github.com/pyenv/pyenv.git "$HOME/.pyenv"

    export PYENV_ROOT="$HOME/.pyenv"
    export PATH="$PYENV_ROOT/bin:$PATH"
    eval "$(pyenv init -)"

    if [ "${SKIP_PYTHON_BUILD:-}" = "1" ]; then
        echo "SKIP_PYTHON_BUILD=1, skipping Python installation."
    elif check_build_deps; then
        echo "Installing Python 3.11.9..."
        pyenv install 3.11.9

        echo "Installing Python 3.12.4..."
        pyenv install 3.12.4

        echo "Setting global Python to 3.12.4..."
        pyenv global 3.12.4

        echo "Installing pre-commit..."
        pip install pre-commit
    else
        echo "Skipping Python installation due to missing build dependencies."
        echo "Run this script again after installing dependencies."
    fi
else
    echo "pyenv already installed, skipping..."
fi
{{- end }}
